<!doctype html>
<!-- paulirish.com/2008/conditional-stylesheets-vs-css-hacks-answer-neither/ -->
<!--[if lt IE 7]> <html class="no-js ie6 oldie" lang="en"> <![endif]-->
<!--[if IE 7]>    <html class="no-js ie7 oldie" lang="en"> <![endif]-->
<!--[if IE 8]>    <html class="no-js ie8 oldie" lang="en"> <![endif]-->
<!--[if IE 9]>    <html class="no-js ie9" lang="en"> <![endif]-->
<!-- Consider adding an manifest.appcache: h5bp.com/d/Offline -->
<!--[if gt IE 9]><!--> <html class="no-js" lang="en" itemscope itemtype="http://schema.org/Product"> <!--<![endif]-->
<head>
  <meta charset="utf-8">

  <!-- Use the .htaccess and remove these lines to avoid edge case issues.
       More info: h5bp.com/b/378 -->
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

  <title>列's Enjoy!!</title>
  <meta name="description" content="" />
  <meta name="keywords" content="" />
  <meta name="author" content="humans.txt">

  <link rel="shortcut icon" href="favicon.png" type="image/x-icon" />

  <!-- Facebook Metadata /-->
  <meta property="fb:page_id" content="" />
  <meta property="og:image" content="" />
  <meta property="og:description" content=""/>
  <meta property="og:title" content=""/>

  <!-- Google+ Metadata /-->
  <meta itemprop="name" content="">
  <meta itemprop="description" content="">
  <meta itemprop="image" content="">

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <!-- We highly recommend you use SASS and write your custom styles in sass/_custom.scss.
     However, there is a blank style.css in the css directory should you prefer -->
  <link rel="stylesheet" href="css/gumby.css">
  <link rel="stylesheet" href="css/custom.css">

  <script src="js/libs/modernizr-2.6.2.min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
  <script src="https://maps.googleapis.com/maps/api/js?v=3.exp&libraries=places"></script>
  <script type="text/javascript" src="http://maps.googleapis.com/maps/api/js?libraries=places&key=AIzaSyCcrhdnh9RPdxkAzL40AnDm9_EkqX-14vg&sensor=true&language=jp&types=establishment"></script>
  <script type="text/javascript" src="https://skyway.io/dist/0.3/peer.js"></script>
  <script src="./js/use_peer.js"></script>
  <script src="./js/libs/md5.min.js"></script>
  <script>
    var map;
    var infowindow;
    var storeList;
    
    function getCurrentPosition() {
    	if (navigator.geolocation) {
    		// オプション・パラメータをセット
    		var position_options = {
    			enableHighAccuracy: true,    // 高精度を要求する
    			timeout: 60000,              // 最大待ち時間（ミリ秒）
    			maximumAge: 0                // キャッシュ有効期間（ミリ秒）
    		};
    		// 現在の位置情報を取得
    		navigator.geolocation.getCurrentPosition(successCallback,errorCallback,position_options);
    	} else {
    		window.alert("本ブラウザではGeolocationが使えません");
    	}
    	
    	// （1）位置情報の取得に成功
    	function successCallback(position) {
    		// 現在地の緯度経度を取り出す
    		var lat = position.coords.latitude ;
    		var lon = position.coords.longitude ;
    		
    		// 近隣のお店を取得
    		getStoreList(lat,lon);
    	}

    	// （2）位置情報の取得に失敗した場合
    	function errorCallback(error) {
    		var message = "";
    		
    		switch (error.code) {
    		
    			// 位置情報が取得できない場合
    			case error.POSITION_UNAVAILABLE:
    				message = "位置情報の取得ができませんでした。";
    				break;
    			
    			// Geolocationの使用が許可されない場合
    			case error.PERMISSION_DENIED:
    				message = "位置情報取得の使用許可がされませんでした。";
    				break;
    			
    			// タイムアウトした場合
    			case error.PERMISSION_DENIED_TIMEOUT:
    				message = "位置情報取得中にタイムアウトしました。";
    				break;
    		}
    		window.alert(message);
    	}
    }

 // 現在地の緯度経度をもとに近隣の店リストを取得
 function getStoreList(lat,lon) {

 	var pyrmont = new google.maps.LatLng(lat,lon);
 	
 	map = new google.maps.Map(document.getElementById('map-canvas'), {
 		center: pyrmont,
 		zoom: 15
 	});
 	
 	var request = {
 		location: pyrmont,
 		radius: 500,
 		types: ['establishment']
 	};
 	infowindow = new google.maps.InfoWindow();
 	var service = new google.maps.places.PlacesService(map);
 	service.nearbySearch(request, callback);
 	
 	function callback(results, status) {
 		var storeListUl = $('#store_list');
 		if (status == google.maps.places.PlacesServiceStatus.OK) {
 			var storeList2 = results;
 			storeList = storeList2;
 			for (var i = 0; i < storeList.length; i++) {
 				storeListUl.append('<tr><td><a class="table-link">' + storeList[i].name + '</td></tr>');
 				createMarker(results[i]);
 			}
 		}
 		getCell();
 	}
 }

 function createMarker(place) {
 	var placeLoc = place.geometry.location;
 	var marker = new google.maps.Marker({
 		map: map,
 		position: place.geometry.location
 	});
 	
 	google.maps.event.addListener(marker, 'click', function() {
 		infowindow.setContent(place.name);
 		infowindow.open(map, this);
 	});
 }

 // クリックされたセルを取得できるようにしておく
 function getCell() {
 	var storeListTable = document.getElementById('store_list');
 	// trをループ。rowsコレクションで,行位置取得。
 	for (var i=0; i<storeListTable.rows.length; i++) {
 	// tr内のtdをループ。cellsコレクションで行内セル位置取得。
 		for (var j=0; j<storeListTable.rows[i].cells.length; j++) {
 			var Cells=storeListTable.rows[i].cells[j]; //i番行のj番列のセル "td"
 			// onclickで 'Mclk'を実行。thisはクリックしたセル"td"のオブジェクトを返す。
 			Cells.onclick =function(){
 				confirmCheckin(this);
 			}
 		}
 	}
 }

 // 店名クリックされたら確認アラートを出す
 function confirmCheckin(Cell) {
 	var checkinStore = storeList[Cell.parentNode.rowIndex];
 	if (window.confirm("「" + checkinStore.name + "」へチェックインしますか？")) {
 		// YESのときのみチェックイン処理をする
 		// アクティブなpeerIdリストの取得
 		localStrage(checkinStore);
 		// TODO:最終的にはnew_profile.htmlに遷移する
 	}
 }

 function localStrage(checkinStore) {
 	// storeIdを取得（少数点以下は4桁）
 	var storeLatArr = checkinStore.geometry.location.lat().toFixed(4).split('.');		// 緯度
 	var storeLngArr = checkinStore.geometry.location.lng().toFixed(4).split('.');	//経度
 	var storeStorageKey = 'store_' + storeLngArr[0] + '-' + storeLngArr[1] + '_' + storeLatArr[0] + '-' + storeLatArr[1];
 	
 	// 1桁の数字を0埋めで2桁にする
 	var toDoubleDigits = function(num) {
 		num += "";
 		if (num.length === 1) {
 			num = "0" + num;
 		}
 		return num;     
 	};
 	
 	// (1) meデータの有無の確認
 	var meData = JSON.parse(window.localStorage.getItem('me'));
 	if (meData) {
 		// データがあれば更新
 		window.localStorage.setItem('me',JSON.stringify({'user_id':meData.user_id,'peer_id':peer.id,'store_id':storeStorageKey}));
 	} else {
 		// 自身のデータがないならまずはidを作成
 		// ユーザーエージェント＋現在日時ミリ秒をハッシュ化
 		var date = new Date();
 		var now = date.getTime();
 		var ua = window.navigator.userAgent.toLowerCase();
 		// ハッシュ値（=id）を作成
 		var meId = md5(ua) + md5(now);
 		// 自身のデータを作成
 		window.localStorage.setItem('me',JSON.stringify({'user_id':meId,'peer_id':peer.id,'store_id':storeStorageKey}));
 	}
 	// meデータを取得
 	meData = JSON.parse(window.localStorage.getItem('me'));
 	
 	// (2) matrixデータの作成
 	// idはuserId+連番としておく
 	var today=new Date();
 	var checkinDate = toDoubleDigits(today.getFullYear()) + '-' + toDoubleDigits(today.getMonth()+1) + '-' + toDoubleDigits(today.getDate());
 	var checkinTime = checkinDate + ' ' + toDoubleDigits(today.getHours()) + ':' + toDoubleDigits(today.getMinutes()) + ':' + toDoubleDigits(today.getSeconds());
 	var matrixId = 'matrix_log_' + meData.user_id + '-' + toDoubleDigits(today.getFullYear()) + toDoubleDigits(today.getMonth()+1) + toDoubleDigits(today.getDate()) + toDoubleDigits(today.getHours()) + toDoubleDigits(today.getMinutes()) + toDoubleDigits(today.getSeconds());
 	// matrixデータ登録（outは空にしておく）
 	window.localStorage.setItem(matrixId,JSON.stringify({'store_id':storeStorageKey,'user_id':meData.user_id,'date':checkinDate,'in':checkinTime, 'out':''}));
 	
 	// (3)ユーザ自身のデータの確認と更新
 	var meUserData = JSON.parse(window.localStorage.getItem('user_' + meData.user_id));
 	if (meUserData) {
 		// 自身のユーザデータを更新する
 		window.localStorage.setItem('user_' + meData.user_id,JSON.stringify({'matrix_log_ids':meUserData.matrix_log_ids + matrixId,  'peer_id':peer.id}));
// 		window.localStorage.setItem('user_' + meData.user_id, JSON.stringify({'name':meUserData.name,'sex':meUserData.sex,'state':meUserData.state,'age':meUserData.age,'comment':meUserData.comment,'photo': meUserData.photo,'matrix_log_ids':meUserData.matrix_log_ids + matrixId,'peer_id':peer.id}));
 	} else {
 		// 自身のユーザデータ作成する
 		window.localStorage.setItem('user_' + meData.user_id,JSON.stringify({'matrix_log_ids':matrixId,  'peer_id':peer.id}));
 	}

 	// (4) お店データの更新
 	// お店データ作成
 	var storeData = window.localStorage.getItem(storeStorageKey);
 	window.localStorage.setItem(storeStorageKey, JSON.stringify({'name':checkinStore.name,'user_ids':meData.user_id,'chat_ids':peer.id}));

 	// peerIdリストを取得する
 	var req = new XMLHttpRequest();
 	loadText("https://skyway.io/active/list/cc6f5bfa-ec91-11e3-8c36-09d78563cbeb");
 	// リクエストする
 	function loadText(path) {
 		req.onreadystatechange = readyStateChange;
 		// リクエスト発行
 		req.open("get", path, true);
 		req.send("");
 	}
 	
 	// 通信状態変化時イベントハンドラ
 	function readyStateChange() {
 		// 通信完了
 		if(req.readyState == 4) {
 			// テキスト扱いされてしまうので配列にする
 			var subText = req.responseText.replace(/\[|\]|\"/g, '');
 			var peerIdList = subText.split(',');
 			if (peerIdList.length <= 0) {
 				// １番目なので画面遷移する
				var meData = JSON.parse(window.localStorage.getItem('me'));
				var meUserData = JSON.parse(window.localStorage.getItem('user_' + meData.user_id));
				if (meUserData.name) {
					// チャットへ遷移
 					location.href = "chat.html";
				} else {
					// プロフ登録へ遷移
 					location.href = "new_profile.html";
				}
 			} else {
	 			// 全員にチェックインリクエスト送る
	 			sendData(peerIdList);
 			}
 		}
 	}
 }

 function sendData(peerIdList) {
 	// Connect to a peer
 	// チェックインリクエスト用データ作成
 	// meデータを取得
 	meData = JSON.parse(window.localStorage.getItem('me'));
 	// 自身のユーザデータ取得
 	var myUserData = 'user_' + meData.user_id + ':' + window.localStorage.getItem('user_' + meData.user_id);
 	// localStrageのデータ全件からmatrix_log_を全件取得する
 	var matrixData = [];
 	for(var i = 0; i < window.localStorage.length; i++){  
 	　　// キー名の取得  
 	　　var k = window.localStorage.key(i);  
 	　　　// matrix_log_[user_id]_で始まるデータを判別する
 			var str = ' ' + k;
 			if (str.indexOf(' matrix_log_' + meData.user_id + '-') !== -1) {
 				var mData = window.localStorage.getItem(k);
 				matrixData.push(k + ':' + mData);
 			}
 	}

 	// 全員にチェックインリクエスト送る
	console.log(peerIdList);
 	reqCount = peerIdList.length;
 	for (var i=0; i<peerIdList.length; i++) {
 		requestedPeer = peerIdList[i];
 		if (!connectedPeers[requestedPeer]) {
 			// リクエスト
 			var c = peer.connect(requestedPeer, {
 				label: 'checkin',
 				serialization: 'none',
 				metadata: {storeId:meData.store_id,userId:meData.user_id, userData:myUserData, matrixDataList:matrixData}
 			});
 			c.on('open', function() {
 				connect(c);
 			});
 			c.on('close', function() {
 				console.log(c.peer + ' cancel.');
 				resCount++;
 				if (resCount == reqCount - 1) {
 					// 取得完了。画面遷移
 					var meData = JSON.parse(window.localStorage.getItem('me'));
 					var meUserData = JSON.parse(window.localStorage.getItem('user_' + meData.user_id));
 					if (meUserData.name) {
 						// チャットへ遷移
 	 					location.href = "chat.html";
 					} else {
 						// プロフ登録へ遷移
 	 					location.href = "new_profile.html";
 					}
 				}
 			});
 			c.on('error', function(err) {
 				resCount++;
 				alert(err);
 			});
 		}
 	connectedPeers[requestedPeer] = 1;
 	}
 }

 // Goes through each active peer and calls FN on its connections.
 function eachActiveConnection(fn) {
 	var actives = $('.active');
 	var checkedIds = {};
 	for(peerId in newCheckinPeers) {
 		if (!checkedIds[peerId]) {
 			var conns = peer.connections[peerId];
 			for (var i = 0, ii = conns.length; i < ii; i += 1) {
 				var conn = conns[i];
 				fn(conn, $(this));
 			}
 		}
 		checkedIds[peerId] = 1;
 	};
 }

 google.maps.event.addDomListener(window, 'load', getCurrentPosition);

 </script>
</head>

<style>
  .btn,.drawer { margin-bottom:10px; }
  .drawer { text-align: center; }
  h1.lead { border-bottom: 1px dotted #ccc; margin-bottom: 30px; }
  h4.lead { margin-bottom:10px; }
  #icon_map ul li { font-size: 16px; }
  .smallify { font-size: 13px; }
  .modal h2, .modal .btn { margin: 5% 0 20px; }
  .ttip.example { float: left; background: #eee; border: 1px dotted #ccc; padding: 20px; }
  html, body, #map-canvas {
    height: 200px;
    margin: 0 0 10px;
    padding: 0px
  }
</style>

<body>

  <!-- Grab Google CDN's jQuery, fall back to local if offline -->
  <!-- 2.0 for modern browsers, 1.10 for .oldie -->
  <script>
  var oldieCheck = Boolean(document.getElementsByTagName('html')[0].className.match(/\soldie\s/g));
  if(!oldieCheck) {
  document.write('<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.2/jquery.min.js"><\/script>');
  } else {
  document.write('<script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.1/jquery.min.js"><\/script>');
  }
  </script>
  <script>
  if(!window.jQuery) {
  if(!oldieCheck) {
    document.write('<script src="js/libs/jquery-2.0.2.min.js"><\/script>');
  } else {
    document.write('<script src="js/libs/jquery-1.10.1.min.js"><\/script>');
  }
  }
  </script>
  
  <!--{共通ヘッダー ここから}-->
  <header class="navbar" id="nav1">
    <div class="row">
      <a class="toggle" gumby-trigger="#nav1 > .row > ul" href="#"><i class="icon-menu"></i></a>
      <h1 class="four columns logo">
        <a href="index.html">
          <img src="img/header_logo.png" gumby-retina />
        </a>
      </h1>
      <ul class="eight columns">
        <li><a href="chat.html"><i class="icon-chat"></i> チャット</a></li>
        <li><a href="map.html"><i class="icon-globe"></i> 行列MAP</a></li>
        <li><a href="ranking.html"><i class="icon-trophy"></i> ランキング</a></li>
        <li><a href="edit_profile.html"><i class="icon-user"></i> プロフィール編集</a></li>
        <li><a href="game.html"><i class="icon-star"></i> しりとり</a></li>
        <li><a href="checkout.html"><i class="icon-logout"></i> チェックアウト</a></li>
      </ul>
    </div>
  </header>
  <!--{共通ヘッダー ここまで}-->
  <div class="wrapper">
  <div class="row">





  <!--{コンテンツ ここから}-->
    <div class="twelve columns">
      <div id="map-canvas"></div>
<!--       <ul>
        <li class="append field">
          <input id="searchTextField" type="text" name="store_search" class="xwide text input" />
          <div class="medium primary btn">
            <a href="new_profile.html">GO</a>
          </div>
        </li>
      </ul> -->
      <table id="store_list" class="striped rounded">
        <tbody>
        </tbody>
      </table>
    </div>
  <!--{コンテンツ ここまで}-->





  </div>
  <div class="footer-fix"></div>
  </div>
  <!--{共通フッター ここから}-->
  <footer class="row footer">
    PRO Team @DEVCAMP 2014
  </footer>
  <!--{共通フッター ここまで}-->
  <!--
  Include gumby.js followed by UI modules followed by gumby.init.js
  Or concatenate and minify into a single file -->
  <script gumby-touch="js/libs" src="js/libs/gumby.js"></script>
  <script src="js/libs/ui/gumby.retina.js"></script>
  <script src="js/libs/ui/gumby.fixed.js"></script>
  <script src="js/libs/ui/gumby.skiplink.js"></script>
  <script src="js/libs/ui/gumby.toggleswitch.js"></script>
  <script src="js/libs/ui/gumby.checkbox.js"></script>
  <script src="js/libs/ui/gumby.radiobtn.js"></script>
  <script src="js/libs/ui/gumby.tabs.js"></script>
  <script src="js/libs/ui/gumby.navbar.js"></script>
  <script src="js/libs/ui/jquery.validation.js"></script>
  <script src="js/libs/gumby.init.js"></script>

  <!--
  Google's recommended deferred loading of JS
  gumby.min.js contains gumby.js, all UI modules and gumby.init.js

  Note: If you opt to use this method of defered loading,
  ensure that any javascript essential to the initial
  display of the page is included separately in a normal
  script tag.

  <script type="text/javascript">
  function downloadJSAtOnload() {
  var element = document.createElement("script");
  element.src = "js/libs/gumby.min.js";
  document.body.appendChild(element);
  }
  if (window.addEventListener)
  window.addEventListener("load", downloadJSAtOnload, false);
  else if (window.attachEvent)
  window.attachEvent("onload", downloadJSAtOnload);
  else window.onload = downloadJSAtOnload;
  </script> -->

  <script src="js/plugins.js"></script>
  <script src="js/main.js"></script>

  <!-- Change UA-XXXXX-X to be your site's ID -->
  <!--<script>
  window._gaq = [['_setAccount','UAXXXXXXXX1'],['_trackPageview'],['_trackPageLoadTime']];
  Modernizr.load({
    load: ('https:' == location.protocol ? '//ssl' : '//www') + '.google-analytics.com/ga.js'
  });
  </script>-->

  <!-- Prompt IE 6 users to install Chrome Frame. Remove this if you want to support IE 6.
     chromium.org/developers/how-tos/chrome-frame-getting-started -->
  <!--[if lt IE 7 ]>
  <script src="//ajax.googleapis.com/ajax/libs/chrome-frame/1.0.3/CFInstall.min.js"></script>
  <script>window.attachEvent('onload',function(){CFInstall.check({mode:'overlay'})})</script>
  <![endif]-->

  </body>
</html>
