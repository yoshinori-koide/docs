<!doctype html>
<!-- paulirish.com/2008/conditional-stylesheets-vs-css-hacks-answer-neither/ -->
<!--[if lt IE 7]> <html class="no-js ie6 oldie" lang="en"> <![endif]-->
<!--[if IE 7]>    <html class="no-js ie7 oldie" lang="en"> <![endif]-->
<!--[if IE 8]>    <html class="no-js ie8 oldie" lang="en"> <![endif]-->
<!--[if IE 9]>    <html class="no-js ie9" lang="en"> <![endif]-->
<!-- Consider adding an manifest.appcache: h5bp.com/d/Offline -->
<!--[if gt IE 9]><!--> <html class="no-js" lang="en" itemscope itemtype="http://schema.org/Product"> <!--<![endif]-->
<head>
  <meta charset="utf-8">

  <!-- Use the .htaccess and remove these lines to avoid edge case issues.
       More info: h5bp.com/b/378 -->
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

  <title>列's Enjoy!!</title>
  <meta name="description" content="" />
  <meta name="keywords" content="" />
  <meta name="author" content="humans.txt">

  <link rel="shortcut icon" href="favicon.png" type="image/x-icon" />

  <!-- Facebook Metadata /-->
  <meta property="fb:page_id" content="" />
  <meta property="og:image" content="" />
  <meta property="og:description" content=""/>
  <meta property="og:title" content=""/>

  <!-- Google+ Metadata /-->
  <meta itemprop="name" content="">
  <meta itemprop="description" content="">
  <meta itemprop="image" content="">

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <!-- We highly recommend you use SASS and write your custom styles in sass/_custom.scss.
     However, there is a blank style.css in the css directory should you prefer -->
  <link rel="stylesheet" href="css/gumby.css">
  <link rel="stylesheet" href="css/custom.css">

  <script src="js/libs/modernizr-2.6.2.min.js"></script>
  <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.8/jquery.min.js"></script>
  <script type="text/javascript" src="https://skyway.io/dist/0.3/peer.js"></script>
  <script src="js/use_peer.js"></script>
  <script src="js/display-controll.js"></script>
  <script>
  	var myId;
  	var msgCnt = 0;
  	var msgObj;
  	var meObj = JSON.parse(localStorage.getItem("me"));
  	
  	// ページ遷移時、peerIdが変更されてしまうため再接続
  	$(window).load(function(){
  		// ユーザデータの保存
  		getPeerIdList();
	 	// ユーザデータ送信
	 	var userObj = JSON.parse(localStorage.getItem('user_' + meObj.user_id));
	 	$('#checkInStoreName').append(userObj.store_name);
  		// チャット出力処理
  		if(userObj.chat_ids.length > 0){
  			var chatArray = userObj.chat_ids.split(",");
  			
  			for(var index in chatArray){
  				var chatObj = JSON.parse(localStorage.getItem('chat_' + chatArray[index]));
  				if(chatObj !== null){
  					// てきとーに表示、時系列並び替え必要かも
  					var userObj = JSON.parse(localStorage.getItem('user_' + chatObj.user_id));
					   if(chatObj.user_id == meObj.user_id){
					   $('#chat-space').append('<li class="field chat me">' +
					'<div class="user">' +
					"<a href='show_profile.html?id="+meObj.user_id+"' class='photo'><img src=" + userObj.photo + "></a>" +
					'<a href="show_profile.html" class="name">' + userObj.name + '</a>' +
					'</div>' +
					'<p class="msg">' +
					'<time>' + chatObj.date + '</time>' +
					chatObj.msg +
					'</p></li>');
					   }else{
					$('#chat-space').append('<li class="field chat">' +
					'<div class="user">' +
					"<a href='show_profile.html?id="+meObj.user_id+"' class='photo'><img src=" + userObj.photo + "></a>" +
					'<a href="show_profile.html" class="name">' + userObj.name + '</a>' +
					'</div>' +
					'<p class="msg">' +
					'<time>' + chatObj.date + '</time>' +
					chatObj.msg +
					'</p></li>');
					   }
 				}
  			}
  		}
  		
  		connectAllPeer();
  	});
  	
  	function connectAllPeer(){
  		// peerIdリストを取得する
 		var req = new XMLHttpRequest();
 		// req.onreadystatechange = readyStateChange;
 		// リクエスト発行
 		req.open("get",
 			"https://skyway.io/active/list/cc6f5bfa-ec91-11e3-8c36-09d78563cbeb",
 			false);
 		req.send(null);
 		var subText = req.responseText.replace(/\[|\]|\"/g, '');
 		var peerIdList = subText.split(',');
 				if (peerIdList.length > 0) {
	 				for(var i=0; i<peerIdList.length; i++) {
		 				// 全員にチャットデータを送る
	 					var c = peer.connect(peerIdList[i], {
						 	label: 'chat',
						 	serialization: 'none',
						 	metadata: meObj.store_id
						 });
						 
						 c.on('connection', connect);
 				}
 		}
  	}
  	
  	function connectedAllPeer(msg){
  		for(var targetId in chatConnectArray){
  			var conns = peer.connections[targetId];
  			conns.send(msg);
  		}
  	}
  
  	$(document).ready(function() {
  		function doNothing(e){
  			e.preventDefault();
  			e.stopPropagation();
  		}
  
  		
  		// Send a chat message to all active connections.
  		$('#send').submit(function(e) {
  			e.preventDefault();
  			// For each active connection, send the message.
  			var nowTime = new Date();
  			// 日時を数値化
  			var strTime = nowTime.getFullYear() + '-' +
  				      (nowTime.getMonth() + 1) + '-' +
  				      nowTime.getDate() + " " +
  				      nowTime.getHours() + ':' +
  				      nowTime.getMinutes() + ':' +
  				      nowTime.getSeconds();
  			msgObj = {
  				'store_id': meObj.store_id,
  				'user_id': meObj.user_id,
  				'msg' : $('#text').val(),
  				'date' : strTime
  			};
  			// 接続済みのすべてのユーザにメッセージを送信
  			connectedAllPeer(msgObj);
  	    		
  	    		var userObj = JSON.parse(localStorage.getItem('user_' + meObj.user_id));
  			// 自身に表示する処理
  			$('#chat-space')
  			      .append('<li class="field chat me"><div class="user">' + 
                        '<a href="show_profile.html" class="photo"><img src=' + userObj.photo + '></a>' +
                        '<a href="show_profile.html" class="name">' + userObj.name + '</a>'  +
                        '</div>' +
                        '<p class="msg">' +
                        '<time>' + msgObj.date + '</time>' +
                        msgObj.msg +
                        '</p></li>');
  			
  			// チャットに追加する処理
  			addchat(JSON.stringify(msgObj));
  			
  		    $('#text').val('');
  		    $('#text').focus();
  	  	});
  	});

  	// Make sure things clean up properly.
  
  	window.onunload = window.onbeforeunload = function(e) {
  		if (!!peer && !peer.destroyed) {
  		    peer.destroy();
  		}
  	};
  
  </script>
</head>

<style>
  .btn,.drawer { margin-bottom:10px; }
  .drawer { text-align: center; }
  h1.lead { border-bottom: 1px dotted #ccc; margin-bottom: 30px; }
  h4.lead { margin-bottom:10px; }
  #icon_map ul li { font-size: 16px; }
  .smallify { font-size: 13px; }
  .modal h2, .modal .btn { margin: 5% 0 20px; }
  .ttip.example { float: left; background: #eee; border: 1px dotted #ccc; padding: 20px; }
</style>

<body>

  <!-- Grab Google CDN's jQuery, fall back to local if offline -->
  <!-- 2.0 for modern browsers, 1.10 for .oldie -->
  <script>
  var oldieCheck = Boolean(document.getElementsByTagName('html')[0].className.match(/\soldie\s/g));
  if(!oldieCheck) {
  document.write('<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.2/jquery.min.js"><\/script>');
  } else {
  document.write('<script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.1/jquery.min.js"><\/script>');
  }
  </script>
  <script>
  if(!window.jQuery) {
  if(!oldieCheck) {
    document.write('<script src="js/libs/jquery-2.0.2.min.js"><\/script>');
  } else {
    document.write('<script src="js/libs/jquery-1.10.1.min.js"><\/script>');
  }
  }
  </script>
  
  <!--{共通ヘッダー ここから}-->
  <header class="navbar" id="nav1">
    <div class="row">
      <a class="toggle" gumby-trigger="#nav1 > .row > ul" href="#"><i class="icon-menu"></i></a>
      <h1 class="four columns logo">
        <a href="index.html">
          <img src="img/header_logo.png" gumby-retina />
        </a>
      </h1>
      <ul class="eight columns">
        <li><a href="chat.html"><i class="icon-chat"></i> チャット</a></li>
        <li><a href="map.html"><i class="icon-globe"></i> 行列MAP</a></li>
        <li><a href="ranking.html"><i class="icon-trophy"></i> ランキング</a></li>
        <li><a href="edit_profile.html"><i class="icon-user"></i> プロフィール編集</a></li>
        <li><a href="game.html"><i class="icon-star"></i> しりとり</a></li>
        <li><a onClick="checkOut()"><i class="icon-logout"></i> チェックアウト</a></li>
      </ul>
    </div>
  </header>
  <!--{共通ヘッダー ここまで}-->
  <div class="wrapper wrapper-chat">





  <!--{コンテンツ ここから}-->
  <div class="row page-header">
    <div class="twelve columns">
      <h3 id="checkInStoreName"><i class="icon-chat"></i></h3>
    </div>
  </div>
  <div class="row chat-timeline">
    <div class="chat-timeline-wrapper">
      <div class="twelve columns">
        <ul id="chat-space">
        </ul>
      </div>
    </div>
  </div>
  <div class="footer-fix footer-fix-chat"></div>
  <!--{コンテンツ ここまで}-->





  </div>
  <!--{共通フッター ここから}-->
  <footer class="row footer footer-chat">
    <div class="row chatsend">
      <div class="twelve columns">
        <ul>
          <li class="field">
          	<form id="send">
	            <div class="medium metro rounded success btn btn-send">
	              <input class = "button" type="submit" >送信</button>
	            </div>
	            <textarea class="input textarea" placeholder="コメント" rows="3" id="text"></textarea>
            	</form>
          </li>
        </ul>
      </div>
    </div>
  </footer>
  <!--{共通フッター ここまで}-->
  <!--
  Include gumby.js followed by UI modules followed by gumby.init.js
  Or concatenate and minify into a single file -->
  <script gumby-touch="js/libs" src="js/libs/gumby.js"></script>
  <script src="js/libs/ui/gumby.retina.js"></script>
  <script src="js/libs/ui/gumby.fixed.js"></script>
  <script src="js/libs/ui/gumby.skiplink.js"></script>
  <script src="js/libs/ui/gumby.toggleswitch.js"></script>
  <script src="js/libs/ui/gumby.checkbox.js"></script>
  <script src="js/libs/ui/gumby.radiobtn.js"></script>
  <script src="js/libs/ui/gumby.tabs.js"></script>
  <script src="js/libs/ui/gumby.navbar.js"></script>
  <script src="js/libs/ui/jquery.validation.js"></script>
  <script src="js/libs/gumby.init.js"></script>

  <!--
  Google's recommended deferred loading of JS
  gumby.min.js contains gumby.js, all UI modules and gumby.init.js

  Note: If you opt to use this method of defered loading,
  ensure that any javascript essential to the initial
  display of the page is included separately in a normal
  script tag.

  <script type="text/javascript">
  function downloadJSAtOnload() {
  var element = document.createElement("script");
  element.src = "js/libs/gumby.min.js";
  document.body.appendChild(element);
  }
  if (window.addEventListener)
  window.addEventListener("load", downloadJSAtOnload, false);
  else if (window.attachEvent)
  window.attachEvent("onload", downloadJSAtOnload);
  else window.onload = downloadJSAtOnload;
  </script> -->

  <script src="js/plugins.js"></script>
  <script src="js/main.js"></script>

  <!-- Change UA-XXXXX-X to be your site's ID -->
  <!--<script>
  window._gaq = [['_setAccount','UAXXXXXXXX1'],['_trackPageview'],['_trackPageLoadTime']];
  Modernizr.load({
    load: ('https:' == location.protocol ? '//ssl' : '//www') + '.google-analytics.com/ga.js'
  });
  </script>-->

  <!-- Prompt IE 6 users to install Chrome Frame. Remove this if you want to support IE 6.
     chromium.org/developers/how-tos/chrome-frame-getting-started -->
  <!--[if lt IE 7 ]>
  <script src="//ajax.googleapis.com/ajax/libs/chrome-frame/1.0.3/CFInstall.min.js"></script>
  <script>window.attachEvent('onload',function(){CFInstall.check({mode:'overlay'})})</script>
  <![endif]-->

  </body>
</html>
